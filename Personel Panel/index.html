<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Doƒüu A≈û ¬∑ Envanter ve S√ºre√ß Takibi</title>
    <meta name="description" content="Doƒüu A≈û i√ßin modern, yalƒ±n envanter ve s√ºre√ß takip paneli." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app">

      <!-- Mobil men√º i√ßin √ßekmece anahtarƒ± (JS yok) -->

      <!-- Sekmeler (JS yok: aktif durum izleme) -->
      <input type="radio" name="tab" id="tab-stok" class="visually-hidden" checked />
      <input type="radio" name="tab" id="tab-gecmis" class="visually-hidden" />
      <input type="radio" name="tab" id="tab-planlanan" class="visually-hidden" />
      <input type="radio" name="tab" id="tab-aktif" class="visually-hidden" />

      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar" aria-label="Birincil">
        <div class="brand">
          <span class="brand__logo" aria-hidden="true">‚óÜ</span>
          <span class="brand__name">Doƒüu A≈û</span>
        </div>

        <nav class="nav" aria-label="B√∂l√ºmler">
          <label class="nav__item" for="tab-stok">
            <span class="nav__icon" aria-hidden="true">üì¶</span>
            <span class="nav__label">Stok Durumu</span>
          </label>
          <div class="nav__divider"></div>
          <label class="nav__item" for="tab-planlanan">
            <span class="nav__icon" aria-hidden="true">üóìÔ∏è</span>
            <span class="nav__label">Planlanan</span>
          </label>
          <label class="nav__item" for="tab-aktif">
            <span class="nav__icon" aria-hidden="true">‚öôÔ∏è</span>
            <span class="nav__label">Aktif ƒ∞≈üler</span>
          </label>
          <label class="nav__item" for="tab-gecmis">
            <span class="nav__icon" aria-hidden="true">üóÇÔ∏è</span>
            <span class="nav__label">Ge√ßmi≈ü</span>
          </label>
        </nav>

        <div class="sidebar__footer">
          <small>v0.1 ‚Ä¢ Vanilla</small>
        </div>
      </aside>

      <!-- Main -->
      <main class="main" role="main">
        <header class="topbar">
          <!-- Mobil men√º d√ºƒümesi -->
          <button class="icon-btn" type="button" aria-label="Men√º" aria-controls="sidebar">‚ò∞</button>

          <!-- Ba≈ülƒ±k (aktif sekmeye g√∂re g√∂r√ºn√ºr) -->
          <h1 class="title title--stok">Stok Durumu</h1>
          <h1 class="title title--gecmis">Ge√ßmi≈ü</h1>
          <h1 class="title title--planlanan">Planlanan</h1>
          <h1 class="title title--aktif">Aktif ƒ∞≈üler</h1>

          <div class="topbar__spacer"></div>

          <div class="topbar__actions">
            <button class="btn btn--ghost" id="btn-logout" type="button">√áƒ±kƒ±≈ü</button>
          </div>
        </header>

        <!-- ƒ∞√ßerik -->
        <section class="content">


          <!-- Stok Durumu -->
          <section class="view" id="view-stok" aria-labelledby="title-stok">
            <h2 class="sr-only" id="title-stok">Stok Durumu</h2>

            <div class="cards">
              <article class="card">
                <header class="card__header">Toplam SKU</header>
                <div class="card__value">1.248</div>
                <footer class="card__footer">%2,3 ge√ßen haftaya g√∂re</footer>
              </article>

              <article class="card">
                <header class="card__header">Stokta</header>
                <div class="card__value">%93</div>
                <footer class="card__footer">Yeniden sipari≈ü: 17 kalem</footer>
              </article>

              <article class="card">
                <header class="card__header">D√º≈ü√ºk / Kritik</header>
                <div class="card__value">8</div>
                <footer class="card__footer">Otomatik uyarƒ±lar a√ßƒ±k</footer>
              </article>

              <article class="card">
                <header class="card__header">A√ßƒ±k Satƒ±nalmalar</header>
                <div class="card__value">12</div>
                <footer class="card__footer">ETA: 2‚Äì7 g√ºn</footer>
              </article>
            </div>

            <div class="panel">
              <header class="panel__header">
                <h3>Yeniden Sipari≈ü Kuyruƒüu</h3>
                <div class="panel__actions">
                  <button class="btn" id="btn-export" type="button">Dƒ±≈üa aktar</button>
                  <button class="btn btn--ghost" id="btn-add-sku" type="button">√úr√ºn ekle</button>
                </div>
              </header>

              <div class="table-wrap">
                <table class="table" aria-label="Yeniden sipari≈ü kuyruƒüu">
                  <thead>
                    <tr>
                      <th>SKU</th>
                      <th>√úr√ºn</th>
                      <th>Elde</th>
                      <th>Asgari</th>
                      <th>Tedarik√ßi</th>
                      <th>Durum</th>
                    </tr>
                  </thead>
                  <tbody id="reorderTable">
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Ge√ßmi≈ü -->
          <section class="view" id="view-gecmis" aria-labelledby="title-gecmis">
            <h2 class="section-title" id="title-gecmis">Ge√ßmi≈ü</h2>
            <p class="muted">Son hareketler ve stok d√ºzeltmeleri.</p>

            <div class="panel">
              <header class="panel__header">
                <h3>Son 7 G√ºn</h3>
                <div class="panel__actions">
                  <button class="btn btn--ghost" id="btn-history-filter" type="button">Filtrele</button>
                </div>
              </header>
              <div id="historyFilterBar" class="panel__filter" style="display:none; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.06)">
                <form id="historyFilterForm" class="filter-row" style="display:flex; gap:10px; flex-wrap:wrap">
                  <input type="text" name="company" placeholder="≈ûirket / Tedarik√ßi (√∂rn. Adalƒ± Holding)" class="search" style="min-width:240px">
                  <input type="text" name="item" placeholder="√úr√ºn/anahtar kelime (√∂rn. Demir)" class="search" style="min-width:200px">
                  <input type="date" name="from" class="search">
                  <input type="date" name="to" class="search">
                  <label for="sort_by" class="sr-only">Sƒ±rala</label>
                  <select id="sort_by" class="search" name="sort_by" style="min-width:160px" aria-label="Sƒ±rala">
                    <option value="date">Tarihe g√∂re</option>
                    <option value="price">Fiyata g√∂re</option>
                    <option value="product">√úr√ºne g√∂re</option>
                  </select>

                  <label for="sort_dir" class="sr-only">Y√∂n</label>
                  <select id="sort_dir" class="search" name="sort_dir" style="min-width:120px" aria-label="Sƒ±ralama y√∂n√º">
                    <option value="desc">Azalan</option>
                    <option value="asc">Artan</option>
                  </select>
                  <button class="btn" type="submit">Ara</button>
                  <button class="btn btn--ghost" id="btn-history-clear" type="button">Temizle</button>
                </form>
              </div>

              <ul class="timeline" id="historyList">
              </ul>
            </div>
          </section>

          <!-- Planlanan -->
          <section class="view" id="view-planlanan" aria-labelledby="title-planlanan">
            <h2 class="section-title" id="title-planlanan">Planlanan</h2>
            <p class="muted">Yakla≈üan satƒ±nalmalar, √ºretim ve rezervasyonlar.</p>

            <div class="panel">
              <header class="panel__header">
                <h3>Yakla≈üanlar</h3>
                <div class="panel__actions">
                  <button class="btn" type="button" id="btn-new-plan">Yeni Plan</button>
                </div>
              </header>

              <div class="kanban">
                <div class="kanban__col">
                  <h4>√ñn√ºm√ºzdeki 7 G√ºn</h4>
                  <ul class="kanban__list" data-col="soon"></ul>
                </div>
                <div class="kanban__col">
                  <h4>√ñn√ºm√ºzdeki 30 G√ºn</h4>
                  <ul class="kanban__list" data-col="month"></ul>
                </div>
                <div class="kanban__col">
                  <h4>Bekleme</h4>
                  <ul class="kanban__list" data-col="backlog"></ul>
                </div>
              </div>
            </div>
          </section>

          <!-- Aktif ƒ∞≈üler -->
          <section class="view" id="view-aktif" aria-labelledby="title-aktif">
            <h2 class="section-title" id="title-aktif">Aktif ƒ∞≈üler</h2>
            <p class="muted">Devam eden i≈ü emirleri ve g√∂revler.</p>

            <div class="grid" id="jobsGrid"></div>
          </section>

          <dialog id="dlg-add-sku">
            <form method="dialog" id="form-add-sku" style="min-width:320px">
              <h3 style="margin:0 0 8px">√úr√ºn Ekle</h3>
              <div style="display:grid; gap:8px">
                <input class="search" name="sku_id" placeholder="SKU (√∂rn. A-1002)" required>
                <input class="search" name="name" placeholder="√úr√ºn adƒ± (√∂rn. Demir √áubuk 10 mm)" required>
                <input class="search" name="min_qty" placeholder="Asgari stok" type="number" min="0" required>
                <input class="search" name="supplier" placeholder="Tedarik√ßi (√∂rn. Adalƒ± Holding)">
                <input class="search" name="initial_qty" placeholder="Ba≈ülangƒ±√ß miktarƒ± (opsiyonel)" type="number">
              </div>
              <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
                <button class="btn btn--ghost" type="submit" data-cancel="1" formnovalidate formmethod="dialog" onclick="this.closest('dialog').close()">Vazge√ß</button>
                <button class="btn" value="submit" type="submit">Kaydet</button>
              </div>
            </form>
          </dialog>

          <dialog id="dlg-new-plan">
            <form method="dialog" id="form-new-plan" style="min-width:320px">
              <h3 style="margin:0 0 8px">Yeni Plan</h3>
              <div style="display:grid; gap:8px">
                <input class="search" name="title" placeholder="Ba≈ülƒ±k (√∂rn. PO #4520 ‚Äì Rulman 6203)" required>
                <select class="search" name="bucket" required>
                  <option value="soon">√ñn√ºm√ºzdeki 7 G√ºn</option>
                  <option value="month">√ñn√ºm√ºzdeki 30 G√ºn</option>
                  <option value="backlog">Bekleme</option>
                </select>
              </div>
              <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
                <button class="btn btn--ghost" type="submit" data-cancel="1" formnovalidate formmethod="dialog" onclick="this.closest('dialog').close()">Vazge√ß</button>
                <button class="btn" value="submit" type="submit">Ekle</button>
              </div>
            </form>
          </dialog>
        </section>
      </main>
    </div>
    <script src="../session.js"></script>
    <script>
      window.addEventListener('DOMContentLoaded', ()=>{
        const user = window.MockAuth?.enforceAccess({ allow: ['viewer','manager','admin'] });
        if (user) window.MockAuth.applyRoleUI(user);
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('btn-logout');
        if (btn) btn.addEventListener('click', () => {
          if (window.MockAuth) window.MockAuth.clearSession();
          // root login sayfasƒ±na d√∂n
          location.href = '../index.html';
        });
      });
    </script>
    <script>
  (function(){
    const $ = (s,ctx=document)=>ctx.querySelector(s);

    // Render helpers
    function renderStats(stats){
      const cards = document.querySelectorAll('#view-stok .cards .card .card__value');
      if(cards[0]) cards[0].textContent = stats.total_skus ?? '-';
      if(cards[1]) cards[1].textContent = stats.in_stock_pct != null ? '%' + stats.in_stock_pct : '-';
      if(cards[2]) cards[2].textContent = stats.critical ?? '-';
      if(cards[3]) cards[3].textContent = stats.open_pos ?? '-';
    }
    function renderReorder(rows){
      const tbody = $('#reorderTable');
      if(!tbody) return;
      tbody.innerHTML = (rows||[]).map(r=>`
        <tr>
          <td>\${r.sku_id || r.sku}</td>
          <td>\${r.item || r.name}</td>
          <td>\${r.on_hand ?? ''}</td>
          <td>\${r.min_qty ?? ''}</td>
          <td>\${r.supplier ?? ''}</td>
          <td>
            <span class="badge \${r.status==='Kritik' ? 'badge--warn' : (r.status==='Uygun' ? 'badge--ok':'')}">\${r.status ?? ''}</span>
          </td>
        </tr>`).join('');
    }
    function renderHistory(items){
      const ul = $('#historyList');
      if(!ul) return;
      ul.innerHTML = (items||[]).map(i=>`
        <li>
          <span class="dot" aria-hidden="true"></span>
          <div>
            <div>\${i.text}</div>
            <div class="meta">\${i.t}</div>
          </div>
        </li>`).join('');
    }
    function renderPlanned(grouped){
      const map = {soon: '[data-col="soon"]', month: '[data-col="month"]', backlog: '[data-col="backlog"]'};
      Object.keys(map).forEach(k=>{
        const ul = document.querySelector('#view-planlanan ' + map[k]);
        if(ul) ul.innerHTML = (grouped?.[k]||[]).map(t=>`<li class="kanban__item">\${t}</li>`).join('');
      });
    }
    function renderJobs(items){
      const grid = $('#jobsGrid');
      if(!grid) return;
      grid.innerHTML = (items||[]).map(j=>`
        <article class="job">
          <header class="job__head">
            <strong>\${j.id}</strong>
            <span class="badge \${j.status==='Riskli' ? 'badge--warn' : 'badge--ok'}">\${j.status}</span>
          </header>
          <div class="job__title">\${j.title}</div>
          <div class="job__meta"><span>Sorumlu: \${j.owner ?? '-'}</span><span>ETA: \${j.eta ?? '-'}</span></div>
        </article>`).join('');
    }

    async function getJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function postJSON(url, body){
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if(!r.ok) throw new Error(await r.text());
      return r.json().catch(()=> ({}));
    }


    async function refreshAll(){
      try { renderStats(await getJSON('/api/stats')); } catch(e){ console.warn('stats', e); }
      try { renderReorder(await getJSON('/api/reorder')); } catch(e){ console.warn('reorder', e); }
      try { renderHistory(await getJSON('/api/history')); } catch(e){ console.warn('history', e); }
      try { renderPlanned(await getJSON('/api/planned')); } catch(e){ console.warn('planned', e); }
      try { renderJobs(await getJSON('/api/jobs')); } catch(e){ console.warn('jobs', e); }
    }

    // Export CSV for reorder table
    function exportReorderCSV(){
      const rows = Array.from(document.querySelectorAll('#reorderTable tr')).map(tr =>
        Array.from(tr.children).map(td => '"' + (td.textContent||'').replaceAll('"','""') + '"').join(',')
      );
      const csv = ['SKU,√úr√ºn,Elde,Asgari,Tedarik√ßi,Durum'].concat(rows).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'reorder.csv';
      document.body.appendChild(a); a.click(); a.remove();
    }

    // Modals
    const dlgAdd = $('#dlg-add-sku');
    const dlgPlan = $('#dlg-new-plan');

    document.addEventListener('click', (e)=>{
      if(e.target.id === 'btn-export') exportReorderCSV();
      if(e.target.id === 'btn-add-sku' && dlgAdd?.showModal) dlgAdd.showModal();
    });

    // √úr√ºn ekle formu
    const formAdd = $('#form-add-sku');
    formAdd?.addEventListener('submit', async (e)=>{
      if (e.submitter?.dataset?.cancel) { return; } // native dialog close
      e.preventDefault();
      const fd = new FormData(formAdd);
      const payload = {
        sku_id: fd.get('sku_id')?.trim(),
        name: fd.get('name')?.trim(),
        min_qty: Number(fd.get('min_qty')||0),
        supplier: fd.get('supplier')?.trim() || null,
        initial_qty: fd.get('initial_qty') ? Number(fd.get('initial_qty')) : 0
      };
      try {
        await postJSON('/api/skus', payload);
        dlgAdd?.close();
        await refreshAll();
      } catch(err){
        alert('Hata: ' + err.message);
      }
    });

    // "Yeni Plan" butonu (Planlanan panelindeki)
    document.getElementById('btn-new-plan')?.addEventListener('click', ()=>{
      if(dlgPlan?.showModal) dlgPlan.showModal();
    });
    const formPlan = $('#form-new-plan');
    formPlan?.addEventListener('submit', async (e)=>{
      if (e.submitter?.dataset?.cancel) { return; } // native dialog close
      e.preventDefault();
      const fd = new FormData(formPlan);
      const payload = { title: fd.get('title')?.trim(), bucket: fd.get('bucket') };
      try {
        await postJSON('/api/planned', payload);
        dlgPlan?.close();
        await refreshAll();
      } catch(err){
        alert('Hata: ' + err.message);
      }
    });

    // Ge√ßmi≈ü filtre √ßubuƒüu
    const btnFilter = $('#btn-history-filter');
    const bar = $('#historyFilterBar');
    btnFilter?.addEventListener('click', ()=> {
      if(!bar) return;
      bar.style.display = (bar.style.display==='none' || !bar.style.display) ? 'block' : 'none';
    });
    $('#btn-history-clear')?.addEventListener('click', async ()=>{
      document.getElementById('historyFilterForm').reset();
      await refreshAll();
    });
    $('#historyFilterForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const params = new URLSearchParams();
      for(const [k,v] of fd.entries()){ if(v) params.append(k, v); }
      try{
        // Tercih edilen: sunucuda /api/history/search
        const url = '/api/history/search?' + params.toString();
        const r = await fetch(url);
        if(r.ok){
          renderHistory(await r.json());
        } else {
          // Geriye d√∂n√º≈ü: /api/history al ve istemci tarafƒ± filtre uygula
          const base = await getJSON('/api/history');
          const company = (fd.get('company')||'').toString().toLowerCase();
          const item = (fd.get('item')||'').toString().toLowerCase();
          const from = fd.get('from') ? new Date(fd.get('from')+'T00:00:00') : null;
          const to   = fd.get('to')   ? new Date(fd.get('to')  +'T23:59:59') : null;
          const filtered = base.filter(x=>{
            const text = (x.text||'').toLowerCase();
            const okCompany = !company || text.includes(company);
            const okItem = !item || text.includes(item);
            const t = new Date(x.t.replace(' ', 'T'));
            const okFrom = !from || t >= from;
            const okTo = !to || t <= to;
            return okCompany && okItem && okFrom && okTo;
          });
          const sortBy  = (fd.get('sort_by')  || 'date').toString();
          const sortDir = (fd.get('sort_dir') || 'desc').toString();
          const m = sortDir === 'asc' ? 1 : -1;
          filtered.sort((a,b)=>{
            if (sortBy === 'price') return m * ((a.price||0) - (b.price||0));
            if (sortBy === 'product') return m * String(a.product||'').localeCompare(String(b.product||''));
            // default: date (x.t format assumed 'YYYY-MM-DD HH:mm')
            return m * (new Date(a.t.replace(' ', 'T')) - new Date(b.t.replace(' ', 'T')));
          });
          renderHistory(filtered);
        }
      }catch(err){ alert('Hata: ' + err.message); }
    });

    // ƒ∞lk y√ºkleme
    document.addEventListener('DOMContentLoaded', refreshAll);
    if (document.readyState !== 'loading') refreshAll();
  })();
  </script>
  </body>
</html>